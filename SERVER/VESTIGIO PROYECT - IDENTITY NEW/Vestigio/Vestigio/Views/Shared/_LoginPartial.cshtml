@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Vestigio.Data
@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager
@inject VestigioDbContext _context

<div class="d-flex align-items-center gap-3">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);
        var isAdmin = await UserManager.IsInRoleAsync(user, "Admin");

        <!-- Carrito solo para usuarios normales -->
        @if (!isAdmin)
        {
            var userId = UserManager.GetUserId(User);
            var cartItemCount = await _context.Orders
            .Where(o => o.UserId == userId && o.Status == "Pendiente")
            .SelectMany(o => o.OrderDetails)
            .CountAsync();

            <a class="text-body position-relative cart-icon" asp-controller="Cart" asp-action="Index">
                @if (cartItemCount > 0)
                {
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        @cartItemCount
                        <span class="visually-hidden">productos en el carrito</span>
                    </span>
                }
                <i class="bi bi-cart3 text-white fs-5"></i>
            </a>

            <span class="user-name text-white">Level - @user.Level.ToString()</span>
        }

        <!-- Menú de usuario -->
        <div class="dropdown user-menu">
            <a class="btn btn-link d-flex align-items-center p-0 gap-2 text-decoration-none"
                href="#" role="button" id="userMenu"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-label="Menú de usuario">
                <i class="bi bi-person-circle fs-4 text-white"></i>
                <span class="user-name text-truncate" style="max-width: 300px;">
                    @User.Identity?.Name
                </span>
            </a>

            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark mt-2 p-2 shadow-lg" aria-labelledby="userMenu">

                <!-- Opciones comunes -->
                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2 py-2"
                        asp-area="Identity" asp-page="/Account/Manage/Index">
                        <i class="bi bi-person-gear"></i>
                        My Profile
                    </a>
                </li>
                <li>
                    <form method="post" asp-area="Identity" asp-page="/Account/Logout"
                            asp-route-returnUrl="@Url.Action("Index", "Home")">
                        <button type="submit"
                                class="dropdown-item d-flex align-items-center gap-2 py-2 w-100">
                            <i class="bi bi-box-arrow-right"></i>
                            Close Session
                        </button>
                    </form>
                </li>
            </ul>
        </div>
        }
    else
    {
        <!-- Botones de autenticación -->
        <div class="d-flex gap-2 auth-buttons">
            <a class="btn btn-login" asp-area="Identity" asp-page="/Account/Login">
                Login
            </a>
            <a class="btn btn-register" asp-area="Identity" asp-page="/Account/Register">
                Sign Up
            </a>
        </div>
    }
</div>

<style>
    /* Estilos para el carrito */
    .cart-icon {
        transition: transform 0.2s ease;
        margin-right: 1rem;
    }

        .cart-icon:hover {
            transform: translateY(-2px);
        }

    .badge {
        top: -8px;
        right: -10px;
        font-size: 0.65rem;
        padding: 0.35em 0.5em;
        min-width: 1.5rem;
    }

    /* Estilos para el menú de usuario */
    .user-menu .user-name {
        color: rgba(255,255,255,0.85);
        transition: color 0.2s ease;
        font-weight: 500;
    }

    .user-menu:hover .user-name {
        color: var(--accent-color);
    }

    .dropdown-menu {
        min-width: 220px;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .dropdown-item {
        border-radius: 4px;
        transition: all 0.2s ease;
        color: rgba(255,255,255,0.8);
    }

        .dropdown-item:hover {
            background: var(--primary-color);
            color: white;
            padding-left: 1.5rem;
        }

    /* Estilos para los botones de autenticación */
    .btn-login {
        background: white;
        color: var(--primary-color);
        border: 2px solid transparent;
        padding: 0.5rem 1.5rem;
        transition: all 0.3s ease;
    }

        .btn-login:hover {
            background: transparent;
            color: white;
            border-color: white;
        }

    .btn-register {
        background: transparent;
        color: white;
        border: 2px solid white;
        padding: 0.5rem 1.5rem;
        transition: all 0.3s ease;
    }

        .btn-register:hover {
            background: white;
            color: var(--primary-color);
        }
</style>